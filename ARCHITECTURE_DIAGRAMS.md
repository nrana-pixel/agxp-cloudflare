# System Architecture & Data Flow

## Complete System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         YOUR PRODUCT                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  User Authentication (Your existing auth system)             â”‚  â”‚
â”‚  â”‚  â†’ Generates JWT token                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                       â”‚
â”‚                              â–¼                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  React Frontend (cloudflare-edge-frontend)                   â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚  â”‚
â”‚  â”‚  â”‚  Connect   â”‚  â”‚   Deploy   â”‚  â”‚  Variants  â”‚             â”‚  â”‚
â”‚  â”‚  â”‚    CF      â”‚  â”‚   Worker   â”‚  â”‚  Manager   â”‚             â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ HTTP + JWT
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              YOUR BACKEND (Cloudflare Workers + Hono)               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  API Routes                                                   â”‚  â”‚
â”‚  â”‚  â”œâ”€ POST /api/cloudflare/connect                            â”‚  â”‚
â”‚  â”‚  â”œâ”€ GET  /api/cloudflare/zones                              â”‚  â”‚
â”‚  â”‚  â”œâ”€ POST /api/deployments                                   â”‚  â”‚
â”‚  â”‚  â”œâ”€ POST /api/variants                                      â”‚  â”‚
â”‚  â”‚  â””â”€ GET  /api/analytics/:id                                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  D1 Database (SQLite)                                        â”‚  â”‚
â”‚  â”‚  â”œâ”€ cloudflare_connections (encrypted tokens)               â”‚  â”‚
â”‚  â”‚  â”œâ”€ deployments                                             â”‚  â”‚
â”‚  â”‚  â”œâ”€ variants (MASTER COPY)                                  â”‚  â”‚
â”‚  â”‚  â”œâ”€ api_keys (hashed)                                       â”‚  â”‚
â”‚  â”‚  â””â”€ ai_requests (analytics)                                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ Cloudflare API
                              â”‚ (Deploy, Create KV, Upload)
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              USER'S CLOUDFLARE ACCOUNT                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Worker: axp-{siteId}                                        â”‚  â”‚
â”‚  â”‚  â”œâ”€ Route: example.com/*                                    â”‚  â”‚
â”‚  â”‚  â”œâ”€ Secrets: CLIENT_API_KEY, SITE_ID, API_ENDPOINT         â”‚  â”‚
â”‚  â”‚  â””â”€ Binding: VARIANTS â†’ KV Namespace                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                              â”‚                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  KV Namespace: axp-variants-{siteId}                        â”‚  â”‚
â”‚  â”‚  â”œâ”€ "/pricing" â†’ <html>optimized pricing</html>            â”‚  â”‚
â”‚  â”‚  â”œâ”€ "/about" â†’ <html>optimized about</html>                â”‚  â”‚
â”‚  â”‚  â””â”€ "/blog/post" â†’ <html>optimized post</html>             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚ Intercepts traffic
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   AI Bot Visit   â”‚
                    â”‚   GPTBot/1.0     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Data Flow Diagrams

### 1. Connecting Cloudflare Account

```
User                Frontend              Backend              Cloudflare API
 â”‚                     â”‚                     â”‚                      â”‚
 â”‚  Creates token      â”‚                     â”‚                      â”‚
 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                     â”‚                      â”‚
 â”‚                     â”‚                     â”‚                      â”‚
 â”‚  Pastes token       â”‚                     â”‚                      â”‚
 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                     â”‚                      â”‚
 â”‚                     â”‚                     â”‚                      â”‚
 â”‚                     â”‚  POST /connect      â”‚                      â”‚
 â”‚                     â”‚  + JWT + CF token   â”‚                      â”‚
 â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                      â”‚
 â”‚                     â”‚                     â”‚                      â”‚
 â”‚                     â”‚                     â”‚  Verify token        â”‚
 â”‚                     â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                     â”‚                     â”‚                      â”‚
 â”‚                     â”‚                     â”‚  âœ… Valid + account  â”‚
 â”‚                     â”‚                     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
 â”‚                     â”‚                     â”‚                      â”‚
 â”‚                     â”‚                     â”‚  Encrypt token       â”‚
 â”‚                     â”‚                     â”‚  (AES-GCM)           â”‚
 â”‚                     â”‚                     â”‚                      â”‚
 â”‚                     â”‚                     â”‚  Save to D1          â”‚
 â”‚                     â”‚                     â”‚  (encrypted)         â”‚
 â”‚                     â”‚                     â”‚                      â”‚
 â”‚                     â”‚  âœ… Success         â”‚                      â”‚
 â”‚                     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                      â”‚
 â”‚                     â”‚                     â”‚                      â”‚
 â”‚  "Connected!"       â”‚                     â”‚                      â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                     â”‚                      â”‚
```

---

### 2. Deploying Worker

```
User                Frontend              Backend              User's CF Account
 â”‚                     â”‚                     â”‚                      â”‚
 â”‚  Selects zone       â”‚                     â”‚                      â”‚
 â”‚  Enters site ID     â”‚                     â”‚                      â”‚
 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                     â”‚                      â”‚
 â”‚                     â”‚                     â”‚                      â”‚
 â”‚  Clicks "Deploy"    â”‚                     â”‚                      â”‚
 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                     â”‚                      â”‚
 â”‚                     â”‚                     â”‚                      â”‚
 â”‚                     â”‚  POST /deployments  â”‚                      â”‚
 â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                      â”‚
 â”‚                     â”‚                     â”‚                      â”‚
 â”‚                     â”‚                     â”‚  1. Create KV        â”‚
 â”‚                     â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                     â”‚                     â”‚  âœ… KV created       â”‚
 â”‚                     â”‚                     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
 â”‚                     â”‚                     â”‚                      â”‚
 â”‚                     â”‚                     â”‚  2. Upload worker    â”‚
 â”‚                     â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                     â”‚                     â”‚  âœ… Worker uploaded  â”‚
 â”‚                     â”‚                     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
 â”‚                     â”‚                     â”‚                      â”‚
 â”‚                     â”‚                     â”‚  3. Set secrets      â”‚
 â”‚                     â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                     â”‚                     â”‚  âœ… Secrets set      â”‚
 â”‚                     â”‚                     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
 â”‚                     â”‚                     â”‚                      â”‚
 â”‚                     â”‚                     â”‚  4. Add route        â”‚
 â”‚                     â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                     â”‚                     â”‚  âœ… Route added      â”‚
 â”‚                     â”‚                     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
 â”‚                     â”‚                     â”‚                      â”‚
 â”‚                     â”‚                     â”‚  5. Health check     â”‚
 â”‚                     â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                     â”‚                     â”‚  âœ… Worker live      â”‚
 â”‚                     â”‚                     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
 â”‚                     â”‚                     â”‚                      â”‚
 â”‚                     â”‚                     â”‚  6. Save to D1       â”‚
 â”‚                     â”‚                     â”‚                      â”‚
 â”‚                     â”‚  âœ… Deployed!       â”‚                      â”‚
 â”‚                     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                      â”‚
 â”‚                     â”‚                     â”‚                      â”‚
 â”‚  "Worker Live!"     â”‚                     â”‚                      â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                     â”‚                      â”‚
```

---

### 3. Creating a Variant

```
User                Frontend              Backend              User's KV
 â”‚                     â”‚                     â”‚                      â”‚
 â”‚  Enters:            â”‚                     â”‚                      â”‚
 â”‚  - URL: /pricing    â”‚                     â”‚                      â”‚
 â”‚  - HTML: <html>...  â”‚                     â”‚                      â”‚
 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                     â”‚                      â”‚
 â”‚                     â”‚                     â”‚                      â”‚
 â”‚  Clicks "Save"      â”‚                     â”‚                      â”‚
 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                     â”‚                      â”‚
 â”‚                     â”‚                     â”‚                      â”‚
 â”‚                     â”‚  POST /variants     â”‚                      â”‚
 â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                      â”‚
 â”‚                     â”‚                     â”‚                      â”‚
 â”‚                     â”‚                     â”‚  1. Save to D1       â”‚
 â”‚                     â”‚                     â”‚  (master copy)       â”‚
 â”‚                     â”‚                     â”‚                      â”‚
 â”‚                     â”‚                     â”‚  2. Upload to KV     â”‚
 â”‚                     â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                     â”‚                     â”‚                      â”‚
 â”‚                     â”‚                     â”‚  Key: "/pricing"     â”‚
 â”‚                     â”‚                     â”‚  Value: <html>...    â”‚
 â”‚                     â”‚                     â”‚                      â”‚
 â”‚                     â”‚                     â”‚  âœ… Uploaded         â”‚
 â”‚                     â”‚                     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
 â”‚                     â”‚                     â”‚                      â”‚
 â”‚                     â”‚  âœ… Saved!          â”‚                      â”‚
 â”‚                     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                      â”‚
 â”‚                     â”‚                     â”‚                      â”‚
 â”‚  "Variant saved!"   â”‚                     â”‚                      â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                     â”‚                      â”‚
```

---

### 4. AI Bot Visits Site

```
AI Bot              User's Worker         User's KV            Your Backend
 â”‚                     â”‚                     â”‚                      â”‚
 â”‚  GET /pricing       â”‚                     â”‚                      â”‚
 â”‚  User-Agent:        â”‚                     â”‚                      â”‚
 â”‚  GPTBot/1.0         â”‚                     â”‚                      â”‚
 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                     â”‚                      â”‚
 â”‚                     â”‚                     â”‚                      â”‚
 â”‚                     â”‚  Check User-Agent   â”‚                      â”‚
 â”‚                     â”‚  â†’ AI bot detected! â”‚                      â”‚
 â”‚                     â”‚                     â”‚                      â”‚
 â”‚                     â”‚  Lookup "/pricing"  â”‚                      â”‚
 â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                      â”‚
 â”‚                     â”‚                     â”‚                      â”‚
 â”‚                     â”‚  <html>optimized    â”‚                      â”‚
 â”‚                     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                      â”‚
 â”‚                     â”‚                     â”‚                      â”‚
 â”‚  200 OK             â”‚                     â”‚                      â”‚
 â”‚  <html>optimized    â”‚                     â”‚                      â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                     â”‚                      â”‚
 â”‚                     â”‚                     â”‚                      â”‚
 â”‚                     â”‚  Log analytics      â”‚                      â”‚
 â”‚                     â”‚  (non-blocking)     â”‚                      â”‚
 â”‚                     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                     â”‚                     â”‚                      â”‚
 â”‚                     â”‚                     â”‚  Save to D1          â”‚
 â”‚                     â”‚                     â”‚  (ai_requests)       â”‚
```

---

## Storage Architecture

### Your D1 Database (Master Data)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  cloudflare_connections                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  id                  INTEGER PRIMARY KEY â”‚
â”‚  user_id             INTEGER             â”‚
â”‚  encrypted_token     TEXT â† AES-GCM      â”‚
â”‚  account_id          TEXT                â”‚
â”‚  status              TEXT                â”‚
â”‚  created_at          TIMESTAMP           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  deployments                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  id                  INTEGER PRIMARY KEY â”‚
â”‚  user_id             INTEGER             â”‚
â”‚  zone_id             TEXT                â”‚
â”‚  zone_name           TEXT                â”‚
â”‚  worker_name         TEXT                â”‚
â”‚  kv_namespace_id     TEXT â† Points to KV â”‚
â”‚  route_id            TEXT                â”‚
â”‚  status              TEXT                â”‚
â”‚  deployed_at         TIMESTAMP           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  variants (MASTER COPY)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  id                  INTEGER PRIMARY KEY â”‚
â”‚  deployment_id       INTEGER             â”‚
â”‚  url_path            TEXT â† "/pricing"   â”‚
â”‚  content             TEXT â† Full HTML    â”‚
â”‚  content_hash        TEXT â† SHA-256      â”‚
â”‚  created_at          TIMESTAMP           â”‚
â”‚  updated_at          TIMESTAMP           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### User's KV Namespace (Edge Delivery)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  KV: axp-variants-{siteId}              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Key: "/pricing"                        â”‚
â”‚  Value: "<html><body>                   â”‚
â”‚          <h1>Optimized Pricing</h1>     â”‚
â”‚          ...</body></html>"             â”‚
â”‚  Metadata: { hash: "abc123..." }        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Key: "/about"                          â”‚
â”‚  Value: "<html>...</html>"              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Key: "/blog/post-1"                    â”‚
â”‚  Value: "<html>...</html>"              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Security Flow

### Token Encryption

```
Cloudflare API Token (plaintext)
         â”‚
         â–¼
  AES-GCM Encryption
  (256-bit key from Worker secret)
         â”‚
         â–¼
  Encrypted Token (base64)
         â”‚
         â–¼
  Stored in D1 Database
  (cloudflare_connections.encrypted_token)
```

### API Key Generation & Hashing

```
  crypto.getRandomValues(32 bytes)
         â”‚
         â–¼
  Base64URL encode
         â”‚
         â–¼
  Prefix with "sk_live_"
         â”‚
         â–¼
  API Key: "sk_live_abc123..."
         â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                          â”‚
         â–¼                          â–¼
  Send to User              SHA-256 Hash
  (one-time only)                  â”‚
                                   â–¼
                          Store hash in D1
                          (api_keys.key_hash)
```

---

## File Structure

```
f:\AGXP\
â”œâ”€â”€ cloudflare-edge-backend\
â”‚   â”œâ”€â”€ src\
â”‚   â”‚   â”œâ”€â”€ index.ts (Main Hono app)
â”‚   â”‚   â”œâ”€â”€ types\index.ts
â”‚   â”‚   â”œâ”€â”€ utils\
â”‚   â”‚   â”‚   â”œâ”€â”€ encryption.ts (AES-GCM)
â”‚   â”‚   â”‚   â”œâ”€â”€ hashing.ts (SHA-256)
â”‚   â”‚   â”‚   â””â”€â”€ validation.ts
â”‚   â”‚   â”œâ”€â”€ middleware\
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.middleware.ts (JWT)
â”‚   â”‚   â”‚   â””â”€â”€ ratelimit.middleware.ts (KV-based)
â”‚   â”‚   â”œâ”€â”€ services\
â”‚   â”‚   â”‚   â”œâ”€â”€ cloudflare.service.ts (CF API wrapper)
â”‚   â”‚   â”‚   â”œâ”€â”€ deployment.service.ts (Orchestration)
â”‚   â”‚   â”‚   â””â”€â”€ analytics.service.ts
â”‚   â”‚   â”œâ”€â”€ routes\
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.ts (Connect CF)
â”‚   â”‚   â”‚   â”œâ”€â”€ deployments.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ variants.ts
â”‚   â”‚   â”‚   â””â”€â”€ analytics.ts
â”‚   â”‚   â””â”€â”€ templates\
â”‚   â”‚       â””â”€â”€ client-worker.ts (Deployed to user's account)
â”‚   â”œâ”€â”€ tests\ (35 passing tests)
â”‚   â”œâ”€â”€ migrations\0001_initial_schema.sql
â”‚   â”œâ”€â”€ docs\
â”‚   â”‚   â”œâ”€â”€ CLOUDFLARE_API_TOKEN_GUIDE.md
â”‚   â”‚   â”œâ”€â”€ API_TOKEN_QUICK_REFERENCE.md
â”‚   â”‚   â””â”€â”€ USER_INTEGRATION_GUIDE.md
â”‚   â””â”€â”€ README.md, QUICKSTART.md, etc.
â”‚
â”œâ”€â”€ cloudflare-edge-frontend\
â”‚   â”œâ”€â”€ src\
â”‚   â”‚   â”œâ”€â”€ main.tsx
â”‚   â”‚   â”œâ”€â”€ pages\Dashboard.tsx
â”‚   â”‚   â”œâ”€â”€ components\
â”‚   â”‚   â”‚   â”œâ”€â”€ ui\
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ button.tsx
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ input.tsx
â”‚   â”‚   â”‚   â””â”€â”€ VariantManager.tsx
â”‚   â”‚   â”œâ”€â”€ services\api.ts
â”‚   â”‚   â””â”€â”€ lib\utils.ts
â”‚   â””â”€â”€ README.md
â”‚
â””â”€â”€ IMPLEMENTATION_COMPLETE.md (This summary)
```

---

## API Endpoints Summary

```
Authentication:
  POST   /api/cloudflare/connect     Connect CF account
  GET    /api/cloudflare/zones       List zones
  DELETE /api/cloudflare/disconnect  Disconnect

Deployments:
  POST   /api/deployments             Deploy worker
  GET    /api/deployments             List deployments
  DELETE /api/deployments/:id         Delete deployment
  PUT    /api/deployments/:id/variants Resync variants

Variants:
  POST   /api/variants                Create variant
  GET    /api/variants                List variants
  PUT    /api/variants/:id            Update variant
  DELETE /api/variants/:id            Delete variant

Analytics:
  POST   /v1/analytics/log            Log event (from worker)
  GET    /api/analytics/:id           Get analytics
  GET    /api/analytics/:id/summary   Get summary
```

---

**This is your complete system architecture!** ğŸ‰
